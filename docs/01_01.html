<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>BaseCrossドキュメント(2017年)</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h2>１．フルバージョンチュートリアル</h2>
</div>
<!-- コンテンツ　-->
<div id="contents">
<br/>
<h3>１０１．何もしないプロジェクト</h3>
　これから、<b>フルバージョン</b>のサンプルの説明を始めます。このサンプルは<b>FullTutorial001</b>というディレクトリに含まれます。<br />
　<b>BaseCrossDx11.sln</b>というソリューションを開くと<b>Dx11版</b>が起動します。<br />
<br />
　実行結果は以下のような画面が出ます。濃い青の画面です。
<p>&nbsp;</p>
<img src="img/0101a.png" width="80%"/>
<p>図0101a</p>
<p>&nbsp;</p>
<br/>
<h4>解説</h4>
　<b>BaseCrossDx11.sln</b>を開くと、<b>GameSources</b>というプロジェクトがあります。これがゲーム本体と言えます。<br />
　このプロジェクトは<b>Headers</b>というフィルタと<b>Sources</b>というフィルタに分かれています。<br />
　以下は<b>GameSources</b>の内容です。

<p>&nbsp;</p>
<img src="img/0101b.png" width="40%"/>
<p>図0101b</p>
<p>&nbsp;</p>
　サンプルではおおむねファイルはこのような構造になっています。<br />
　それぞれのファイルの役割を簡単に記します。<br />
<br />
<h4>Scene.h/cpp</h4>
　BaseCrossでは、ゲーム上のまとめ役のオブジェクトとして<b>Appクラス</b>、<b>シーン</b>そして<b>ステージ</b>という３つ階層で管理します。<br />
　<b>Scene.h/cpp</b>はその<b>シーン</b>です。ここでは<b>ステージ</b>を管理し切り替えます。<br />
<br />
<h4>GameStage.h/cpp</h4>
　これは<b>ゲームステージ</b>です。<b>シーン</b>により管理されます。サンプルでは主に<b>ゲーム画面</b>を実装しますが、通常は<b>メニュー画面</b>、<b>リザルト画面</b>など、複数のステージで構成されます。その場合、メニューなども<b>GameStage.h/cpp</b>に記述することも可能ですが、複数のファイル<b>ヘッダとcppのペア</b>を作成し、それぞれ別のステージを管理することも可能です。<br />
<br />
<h4>Character.h/cpp</h4>
　ここには、主に<b>プレイヤー以外のステージに配置されるオブジェクト</b>を記述します。実際のゲームでは、サンプルのように単純ではなく、いろんなタイプのオブジェクトを記述する必要があります。ですので、<b>Character.h/cpp</b>のような<b>ヘッダとcppのペア</b>を作成して、そこに記述します。<br />
　例えば<b>敵キャラ</b>などは<b>Enemy.h/cpp</b>などのファイルを記述するとわかりやすいでしょう。<br />
<br />
<h4>Player.h/cpp</h4>
　ここには<b>プレイヤー</b>を記述します。<b>プレイヤー</b>は、<b>コントローラ</b>や<b>キーボード、マウス</b>などの反応してリアルタイムに細かな処理を行う必要があります。当然、ファイルは大きくなります。ですので<b>Character.h/cpp</b>とは別に作成します。<br />
　実際のゲームでは必ずしも<b>Player.h/cpp</b>というファイル名でなくてもかまいません。<br />
<br />
<h4>ProjectShader.h/cpp</h4>
　ここにはコンテンツで定義した<b>シェーダークラス</b>を記述します。<b>シェーダー</b>は特別なファイルです。ライブラリでも基本的なシェーダは実装されてますが、独自に作成する場合<b>.hlsl</b>ファイルを作成します。この<b>ProjectShader.h/cpp</b>は、これらの<b>シェーダ</b>をゲーム内で使用するために作成する<b>中間的なC++ファイル</b>を記述します。<br />
　<b>シェーダそのもの（.hlslファイル）</b>を作成する場合は<b>フィルタ</b>を新しく作成してその中に記述することをお勧めします。<br />
<br/>
<h4>Project.h</h4>
　ここにはコンテンツで使用する<b>ヘッダ</b>をまとめておきます。こうしておくと、コンテンツ内の記述は<b>Project.h</b>をインクルードすればすべてのファイル内に記述されたオブジェクトを使用することができます。<br />
　ただしC++には<b>前方宣言</b>という文法があり、<b>使用するためにはあらかじめ宣言が（場合によっては実体も）</b>必要になります。<br />
　そのため<b>Project.h</b>内は、<b>宣言する順番</b>が重要になります。ポインタや参照を使用するだけなら、<b>クラス宣言や構造体宣言</b>を使用すれば<b>前方宣言</b>は成り立ちますが、それらのメンバ関数呼び出しなどを記述する場合は、<b>Project.h内の順番</b>が上になければなりません。そのあたりを考慮しながら記述します。<br />
<br />
<h4>WinMain.cpp</h4>
　ここには<b>Windowsアプリケーション</b>のエントリポイントである<b>WinMain関数</b>を記述します。この内容を書き換えるのは、例えばキーボードやマウスを使用する場合に<b>使用するキー</b>を登録します。<br />
　<b>BaseCross</b>はコントローラはデフォルトで使用できる形ですが、<b>キーボードやマウス</b>を使用するためにはこの中に記述します。<br />
　<b>WinMain関数</b>は<b>すべての始まり</b>ですから、この記述を書き換えれば、<b>BaseCrossの枠</b>を簡単に超えられます。<br />
　例えば<b>BaseCrossのライブラリは使用したいが使用方法は独自に管理したい</b>などの場合は、ここを変更すれば<b>シーンやステージ</b>あるいは<b>Appクラス</b>の考え方は全く使わずに<b>独自の管理</b>をすることが可能です。<br />
<br />
　以上、サンプル内に含まれるファイルの役割でした。<br />
<br />
<h4>このサンプル独自の内容</h4>
　このサンプルは<b>何もしない</b>サンプルです。通常は実際にゲームを作成する場合の<b>ひな形</b>として使用します。<br />
<br />
　ただ、ゲームエンジン（DirectX）を実装する最低限の処理が実装されています。<br />
　まず、<b>GameStage.h</b>を以下のように記述します。
<div class="box1">
<pre>
#pragma once
#include "stdafx.h"

namespace basecross {
    //--------------------------------------------------------------------------------------
    //  ゲームステージクラス
    //--------------------------------------------------------------------------------------
    class GameStage : public Stage {
        //ビューとライトの作成
        void CreateViewLight();
    public:
        //構築と破棄
        GameStage() :Stage() {}
        virtual ~GameStage() {}
        //初期化
        virtual void OnCreate()override;
    };


}
//end basecross
</pre>
</div>
　ここでは<b>ゲームステージ</b>を記述します。<b>ステージ</b>は<b>メニューステージ</b>などもそうですが、最低限<b>ビューとライト</b>というオブジェクトを実装する必要があります。ここでは、それらを実装する関数<b>void CreateViewLight()関数</b>が宣言されています。<br />
　<b>BaseCross</b>は<b>namespace basecross</b>という<b>ネームスペース</b>に入れます。こうしておくとほかのグローバルな関数などとクラス名などを分離することができます。<br />
　ここに
<div class="box1">
<pre>
        //初期化
        virtual void OnCreate()override;
</pre>
</div>
　という<b>仮想関数</b>があります。この<b>Onなんたら</b>という関数名は、<b>ライブラリから呼び出される関数</b>です。<b>GameStageのOnCreate()関数</b>は<b>GameStageのインスタンスが作成されるときに、ライブラリから呼び出され</b>ます。<br />
　このような仮想関数はほかに<b>OnUoodate()関数、OnDraw関数</b>などがあります。<br />
　使用する場合はこれらの関数を<b>多重定義</b>します。<br />
<br />
　
　続いて<b>GameStage.cpp</b>です。以下のように記述されています。
<div class="box1">
<pre>
#include "stdafx.h"
#include "Project.h"

namespace basecross {

    //--------------------------------------------------------------------------------------
    //  ゲームステージクラス実体
    //--------------------------------------------------------------------------------------
    //ビューとライトの作成
    void GameStage::CreateViewLight() {
        auto PtrView = CreateView&lt;SingleView>();
        //ビューのカメラの設定
        auto PtrCamera = PtrView->GetCamera();
        PtrCamera->SetEye(Vec3(0.0f, 5.0f, -5.0f));
        PtrCamera->SetAt(Vec3(0.0f, 0.0f, 0.0f));
        //シングルライトの作成
        auto PtrSingleLight = CreateLight&lt;SingleLight>();
        //ライトの設定
        PtrSingleLight->GetLight().SetPositionToDirectional(-0.25f, 1.0f, -0.25f);
    }
    void GameStage::OnCreate() {
        try {
            //ビューとライトの作成
            CreateViewLight();
        }
        catch (...) {
            throw;
        }
    }

}
//end basecross
</pre>
</div>
　このように<b>GameStage::CreateViewLight()関数</b>では<b>ビューとライト</b>を設定しています。<b>ビュー</b>というのは、<b>ビューポートとカメラ</b>を組み合わせたものです。<b>1つのビューポートには1つのカメラ</b>が結びついています。複数のビューを使うこともできます。<b>ライト</b>は<b>シャドウマップ</b>や<b>3Dの陰影</b>をつけるために必要なものです。<br />
　これらの設定を行う<b>GameStage::CreateViewLight()関数</b>を<b>GameStage::OnCreate()関数</b>から呼び出します。<br />
　<b>GameStage::OnCreate()関数</b>内にビューやライトの作成を記述してもいいのですが、今後オブジェクトが増えていくと何が何だか分からなくなってしまうので、関連するグループあるいはオブジェクトごとに<b>初期化関数</b>を別に書いたほうが可読性は上がります。<br />
<br />
　最後に<b>Scene.h/cpp</b>を記述します。以下は<b>Scene.h</b>です。
<div class="box1">
<pre>
#pragma once
#include "stdafx.h"
namespace basecross{
    //--------------------------------------------------------------------------------------
    /// ゲームシーン
    //--------------------------------------------------------------------------------------
    class Scene : public SceneBase{
    public:
        //--------------------------------------------------------------------------------------
        /*!
        @brief コンストラクタ
        */
        //--------------------------------------------------------------------------------------
        Scene() :SceneBase(){}
        //--------------------------------------------------------------------------------------
        /*!
        @brief デストラクタ
        */
        //--------------------------------------------------------------------------------------
        virtual ~Scene(){}
        //--------------------------------------------------------------------------------------
        /*!
        @brief 初期化
        @return なし
        */
        //--------------------------------------------------------------------------------------
        virtual void OnCreate() override;
        //--------------------------------------------------------------------------------------
        /*!
        @brief イベント取得
        @return なし
        */
        //--------------------------------------------------------------------------------------
        virtual void OnEvent(const shared_ptr&lt;Event>& event) override;
    };
}
//end basecross
</pre>
</div>
　ここでは、<b>OnCreate()仮想関数</b>のほかに<b>OnEvent()仮想関数</b>があります。これは、<b>イベント</b>といってオブジェクト同士の指標などのやり取りに使用できる仕組みです。<br />
　なぜ、<b>シーン</b>にこのような仕組みが実装されているかは理由がありますが後ほど説明します。<br />
　まずは、<b>Scene.cpp</b>を見てください。以下のようになってます。
<div class="box1">
<pre>
#include "stdafx.h"
#include "Project.h"

namespace basecross{
    //--------------------------------------------------------------------------------------
    /// ゲームシーン
    //--------------------------------------------------------------------------------------
    void Scene::OnCreate() {
        try {
            //クリアする色を設定
            Col4 Col;
            Col.set(31.0f / 255.0f,30.0f / 255.0f,71.0f / 255.0f,255.0f / 255.0f);
            SetClearColor(Col);
            //自分自身にイベントを送る
            //これにより各ステージやオブジェクトがCreate時にシーンにアクセスできる
            PostEvent(0.0f, GetThis&lt;ObjectInterface>(), GetThis&lt;Scene>(), L"ToGameStage");
        }
        catch (...) {
            throw;
        }
    }
    void Scene::OnEvent(const shared_ptr&lt;Event>& event) {
        if (event->m_MsgStr == L"ToGameStage") {
            //最初のアクティブステージの設定
            ResetActiveStage&lt;GameStage>();
        }
    }

}
//end basecross
</pre>
</div>
　シーンもステージ同様構築時に呼ばれるのは<b>Scene::OnCreate()関数</b>です。<br/>
　まず、背景色を濃い青に設定してます。<b>Col4</b>は色を管理するクラスです。内部では、各色、0.0fから1.0fまでの値を持つように設計されています。<br />
　続いては、ここで、<b>ゲームステージをアクティブステージにする</b>という処理は行わずに、
<div class="box1">
<pre>
    //自分自身にイベントを送る
    //これにより各ステージやオブジェクトがCreate時にシーンにアクセスできる
    PostEvent(0.0f, GetThis&lt;ObjectInterface>(), GetThis&lt;Scene>(), L"ToGameStage");
</pre>
</div>
　という処理を行っています。<b>PostEvent()関数</b>は<b>イベント発行の関数</b>です。ここでは<b>自分自身に</b>イベントを送っています。<br />
　これは、コメントにもあるように、<b>ステージからシーンにアクセスできる</b>ようにするためです。<br />
　例えば、ゲーム実行して取得した<b>スコア</b>や<b>ライフ値</b>など、ゲーム全体で管理する変数は、<b>シーン</b>に置いておいたほうが便利なことが多いです。（どのオブジェクトからもアクセスしやすいので）。<br />
　しかし<b>Scene::OnCreate()関数</b>がよばれる時点では、シーンはまだ完全には構築されてないので、そこで<b>ステージ</b>を構築すると、<b>ステージのOnCreate()関数</b>内ではシーンにアクセスできないのです。<br />
　そのため、いったん<b>シーンの構築</b>を済ませてから<b>ステージの構築</b>を行うというテクニックを使用します。<br />
　<b>PostEvent()関数</b>は、そのパラメータはいったんライブラリ内に保持されて、<b>次のターン</b>の最初に指定のオブジェクトに送られます。送られたイベントは<b>OnEvent()仮想関数</b>で受け取ります。シーンの場合は<b>Scene::OnEvent()関数</b>です。<br />
　ですので、その中で<b>ゲームステージの構築</b>である<b>ResetActiveStage&lt;GameStage>();</b>の呼び出しを行います。<br />
　この関数は、指定の型のステージを構築し<b>その中でステージのOnCreate()を呼び出し</b>ます。<br />
<br />
　しかし、このサンプルのように<b>共有するデータ</b>などがなければ直接構築しても問題はありません。<br />
　その場合は<b>Scene.h</b>は以下のように記述します。<br />
<div class="box1">
<pre>
#pragma once

#include "stdafx.h"

namespace basecross{

    //--------------------------------------------------------------------------------------
    /// ゲームシーン
    //--------------------------------------------------------------------------------------
    class Scene : public SceneBase{
    public:
        //--------------------------------------------------------------------------------------
        /*!
        @brief コンストラクタ
        */
        //--------------------------------------------------------------------------------------
        Scene() :SceneBase(){}
        //--------------------------------------------------------------------------------------
        /*!
        @brief デストラクタ
        */
        //--------------------------------------------------------------------------------------
        virtual ~Scene(){}
        //--------------------------------------------------------------------------------------
        /*!
        @brief 初期化
        @return なし
        */
        //--------------------------------------------------------------------------------------
        virtual void OnCreate() override;
    };

}
//end basecross
</pre>
</div>
　そして<b>Scene.cpp</b>は以下のように構築します。
<div class="box1">
<pre>
#include "stdafx.h"
#include "Project.h"

namespace basecross{

    //--------------------------------------------------------------------------------------
    /// ゲームシーン
    //--------------------------------------------------------------------------------------

    void Scene::OnCreate(){
        try {
            //クリアする色を設定
            Col4 Col;
            Col.set(31.0f / 255.0f,30.0f / 255.0f,71.0f / 255.0f,255.0f / 255.0f);
            SetClearColor(Col);
            //最初のアクティブステージの設定
            ResetActiveStage&lt;GameStage>();
        }
        catch (...) {
            throw;
        }
    }



}
//end basecross
</pre>
</div>
　ステージや、ステージに配置するオブジェクトから<b>初期化時にシーンにアクセスする</b>必要がなければこのような記述でも問題ありません。<br />
<br />
　この項では、一番単純な<b>BaseCross</b>アプリケーションの作成方法を紹介しました。<br />
　次項ではもう少し複雑になります。
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="index.html">目次</a></li>
<li><a href="01_02.html">次へ</a></li>
</ul>
<!-- /フッタ　-->


</div>
<!-- /全体コンテナ　-->
</body>
</html>
