<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>BaseCrossドキュメント(2017年)</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h2>５．FBXモデル変換ツール（Fbx2BinVS2015）</h2>
</div>
<!-- コンテンツ　-->
<div id="contents">
<br/>
<h3>５０２．タンジェントがついていないモデルのデータ変換</h3>
　<b>Fbx2BinVS2015</b>でデータ変換できるFBXファイルは、以下のようなデータです。
<div class="box1">
<pre>
１、PNTフォーマットのスタティックモデル
２、PNTフォーマットのアニメーション付きモデル（ボーン付き）
３、PNTnTフォーマットのスタティックモデル（タンジェント付き）
４、PNTnTフォーマットのアニメーション付きモデル（タンジェント・ボーン付き）
</pre>
</div>
　それぞれ現時点では<b>1つのFBXファイルに1つのメッシュ</b>の対応です。FBXファイルは複数のメッシュも実装できますが、現時点では未対応です。<br />
　また<b>アニメーション付きモデル</b>については<b>つながったボーン</b>である必要があります。詳しくは次項以降を参照ください。<br />
<h4>PNTフォーマットのスタティックモデル</h4>
　<b>Fbx2BinVS2015</b>にはいくつかのサンプルがあります。<b>Fbx2BinVS2015\media</b>ディレクトリにありますが、まず、<b>Chara1</b>ディレクトリにある<b>スタティックモデル</b>を読み込んでみます。<br />
　<b>ファイル・FBXファイルを開く</b>で以下のようなダイアログが出ます。
<p>&nbsp;</p>
<img src="img/0502a.png" width="60%"/>
<p>図0502a</p>
<p>&nbsp;</p>
　ここで<b>ファイルの参照</b>をクリックして<b>Fbx2BinVS2015\media\Chara1\Character_01.fbx</b>を選んでみましょう。以下のような感じです。
<p>&nbsp;</p>
<img src="img/0502b.png" width="60%"/>
<p>図0502b</p>
　ここで<b>スケーリング</b>を<b>0.01</b>にしているのは、ゲームの単位系とモデルの単位系は必ずしも同じとは限らないからです。ゲームは<b>BaseCross</b>の場合は<b>1.0は1メートル</b>です。しかし、モデルの場合<b>1.0</b>が<b>1センチ</b>のつもりで作成されているかもわかりません。本当であれば、モデル作成する前に合わせておくのが望ましいです。<br />
　読み込むと以下のような画面が現れます。
<p>&nbsp;</p>
<img src="img/0502c.png" width="80%"/>
<p>図0502c</p>
　このモデルは<b>アニメーションもしないし、法線マップ（タンジェント）も実装しない</b>スタティックモデルです。<br />
　<b>アニメーション</b>メニューを開いても選択できません。<br />
　この<b>Fbx2BinVS2015で読めるFBXファイル</b>はいくつかの制約があります
<div class="box1">
<pre>
１、インデックスごとに頂点が必要
２、1つの頂点に設置できる法線は一つ
３、複数のテクスチャは使用できるが、マテリアルを分ける必要がある。
</pre>
</div>
　３について、少し解説しますと、基本的に1つのモデルには1つのテクスチャ、を奨励しますが、<b>複数のテクスチャ</b>を利用できないわけではありません。ただ<b>１つの頂点に複数のテクスチャ</b>を設定できるわけではありませんので、テクスチャごとに<b>マテリアルを分ける</b>データになっていれば複数のテクスチャを扱えます。<br/>
<br />
　それでは、<b>.bmfファイル</b>を保存してみます。<b>ファイル・バイナリファイルの保存</b>で以下のダイアログが出ます。
<p>&nbsp;</p>
<img src="img/0502d.png" width="60%"/>
<p>図0502d</p>
　ここで<b>OK</b>をクリックすれば<b>FBXファイル</b>と同じディレクトリに<b>.bmfファイル</b>が保存されます。<br/>
<br />
<h4>PNTフォーマットのアニメーション付きモデル（ボーン付き）</h4>
　続いて<b>ボーン付きモデル</b>について説明します。上記の要領で<b>Fbx2BinVS2015\media\Chara_R\Chara_R.fbx</b>を開いてみましょう。スケーリングは上記同様<b>0.01</b>です。以下の画面が出ます。
<p>&nbsp;</p>
<img src="img/0502e.png" width="80%"/>
<p>図0502e</p>
　今度は左上に<b>0.000000</b>という数字と<b>ANIME: STOP</b>と出ています。<br />
　ここで、<b>アニメーション・FBXファイルを動かす</b>を選択してください。すると以下のダイアログが出ますので、以下のような設定をします。
<p>&nbsp;</p>
<img src="img/0502f.png" width="40%"/>
<p>図0502f</p>
　ここでの設定の意味ですが、<b>フレーム数</b>というのは<b>1秒当たりのサンプリングする値</b>です。これはFBXファイル作成時に合わせるのもいいですが、書きだすフレーム数と連動します。<br />
　<b>FBX</b>から<b>.bmf</b>へのデータ変換は<b>サンプリング</b>という考え方で変換します。つまり、1秒のうち、ボーンの行列を<b>いくつサンプリングするか</b>という考え方です。当然細かいほうがFBXを作成した内容に近くなります。<br />
　しかし、実際にゲームでは必ずしも<b>細かいほうが良い</b>とは限りません。スピード感を出すゲームであればサンプル数は少なくして再生速度も速くすることで<b>コミカルなあるいはスピード感のある</b>演出が可能ですしメモリも圧迫しません。<br />
　そのあたりはグラフィッカーと協議の上決めるといいでしょう。<br />
　話は戻りますが、ここでの設定は<b>10フレーム/秒</b>で<b>4秒間</b>ですから、サンプル数は40個になります。1つのサンプルには<b>ボーン行列の配列</b>になりますので、アニメーションデータ量は<b>40×ボーン数×行列のサイズ</b>になります。<br />
　このダイアログで<b>再生</b>をクリックするとアニメーションが再生されます。左上に<b>現在再生されてる秒</b>が表示されます。画面を<b>ダブルクリック</b>すると<b>停止・再生</b>を繰り返します。<br />
　<b>アニメーション</b>に対する制限は<b>1ラインで作成する</b>ということです。FBXでは複数のアニメーションラインを設定できますが、<b>Fbx2BinVS2015</b>では対応されてません。<br />
　では<b>待機</b>、<b>歩く</b>といったアニメーションの違いはどう設定するかということですが、<b>1ライン中</b>の<b>何秒目から何秒間は歩き</b>のような関係になります。こちらは<b>ゲームで使用する</b>ときに<b>アニメーション設定</b>というのを行いますので、<b>つながっていてもいい</b>ことになります。<br />
　ここで紹介したサンプルも、いくつかのアニメーションが連続して入っています。<br />
<br />
　それでは<b>アニメーション付きモデル</b>の保存をしてみましょう<b>ファイル・バイナリファイルの保存</b>で保存ダイアログが出ます。ここで出てくる<b>サンプリング</b>は再生時の<b>フレーム数</b>と同じです。また保存する秒数も<b>再生秒数</b>と同じです。変更する場合は内容を変更してください。
<p>&nbsp;</p>
<img src="img/0502g.png" width="60%"/>
<p>図0502g</p>
　<b>OK</b>で<b>FBXと同じディレクトリ</b>に<b>.bmfファイル</b>を保存します。<br />
<br />
<h4>.bmfファイルの表示</h4>
　このあと、作成した<b>.bmfファイル</b>をゲームで表示したサンプルは<b>FullSample502</b>というサンプルです。起動すれば以下の画面が現れます。<br />
　実装方法は<b>FullSample404</b>を参考にしてください。以下が実行画面です。<br />
<p>&nbsp;</p>
<img src="img/0502h.png" width="80%"/>
<p>図0502h</p>
　ただ1点、このサンプルはツールで作成したモデルの表示の参考のため、<b>mediaディレクトリ</b>にリソースが保存してあります。<br />
　また、メッシュのリソース化は<b>Scene.cpp</b>に記述がありますが、以下のように記述があります。
<div class="box1">
<pre>
void Scene::CreateResourses() {
    wstring DataDir;
    //サンプルのためアセットディレクトリを取得
    App::GetApp()->GetAssetsDirectory(DataDir);
    wstring strTexture = DataDir + L"trace.png";
    App::GetApp()->RegisterTexture(L"TRACE_TX", strTexture);
    strTexture = DataDir + L"sky.jpg";
    App::GetApp()->RegisterTexture(L"SKY_TX", strTexture);

    //データディレクトリを取得
    <span class="red">wstring MediaDir;
    App::GetApp()->GetDataDirectory(MediaDir);</span>
    //スタティックモデルのリソース
    auto StaticModelMesh 
    = MeshResource::CreateStaticModelMesh(MediaDir + L"Chara1\\", L"Character_01.bmf");
    App::GetApp()->RegisterResource(L"MODEL_MESH", StaticModelMesh);
    //ボーンモデルのリソース
    auto BoneModelMesh 
    = MeshResource::CreateBoneModelMesh(MediaDir + L"Chara_R\\", L"Chara_R.bmf");
    App::GetApp()->RegisterResource(L"BONE_MESH", BoneModelMesh);
}
</pre>
</div>
　赤くなっているところが、<b>リソース登録</b>です。これで<b>mediaディレクトリ</b>を取得してその中の該当ディレクトリ内のデータをリソース化しています。
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="05_01.html">前へ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="05_03.html">次へ</a></li>
</ul>
<!-- /フッタ　-->


</div>
<!-- /全体コンテナ　-->
</body>
</html>
